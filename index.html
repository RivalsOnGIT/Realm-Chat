<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
<title>Realm Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Cinzel:wght@400;600&family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,300;1,400&display=swap" rel="stylesheet"/>
<style>
:root{
  --bg:#080810;--surface:#0f0f1a;--surface2:#161625;--surface3:#1e1e30;
  --border:#252535;--border2:#303048;
  --gold:#c9a96e;--gold2:#e8c98a;--gold-dim:rgba(201,169,110,0.12);
  --purple:#7060a0;--purple2:#9580cc;--red:#cc4444;--green:#4a9a6a;
  --text:#ede8df;--text2:#b0a898;--text3:#6a6478;
  --glow:0 0 30px rgba(201,169,110,0.18);--r:12px;
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;overflow:hidden;}
body{background:var(--bg);color:var(--text);font-family:'Crimson Pro',Georgia,serif;font-size:16px;display:flex;flex-direction:column;}

/* screens */
.screen{display:none;flex-direction:column;height:100%;overflow:hidden;}
.screen.active{display:flex;}

/* ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ */
#authScreen{
  align-items:center;justify-content:center;overflow-y:auto;
  padding:1.5rem;gap:1.75rem;
  background:radial-gradient(ellipse at 50% 0%,rgba(201,169,110,0.07) 0%,transparent 60%),var(--bg);
}
.auth-logo h1{font-family:'Cinzel Decorative',serif;font-size:clamp(1.6rem,7vw,2.6rem);color:var(--gold);text-align:center;text-shadow:var(--glow);letter-spacing:0.06em;}
.auth-logo p{color:var(--text3);font-style:italic;text-align:center;font-size:0.88rem;margin-top:0.4rem;}
.auth-box{width:100%;max-width:390px;background:var(--surface);border:1px solid var(--border2);border-radius:16px;padding:1.6rem;display:flex;flex-direction:column;gap:0.9rem;}
.auth-tabs{display:flex;border:1px solid var(--border2);border-radius:8px;overflow:hidden;}
.auth-tab{flex:1;padding:0.55rem;text-align:center;cursor:pointer;font-family:'Cinzel',serif;font-size:0.75rem;letter-spacing:0.06em;color:var(--text3);background:transparent;border:none;transition:all 0.2s;}
.auth-tab.active{background:var(--gold-dim);color:var(--gold);}
.auth-form{display:flex;flex-direction:column;gap:0.75rem;}
.fld{display:flex;flex-direction:column;gap:0.25rem;}
.fld label{font-size:0.72rem;color:var(--text3);letter-spacing:0.06em;}
.fld input{background:var(--bg);border:1px solid var(--border2);border-radius:8px;padding:0.6rem 0.85rem;color:var(--text);font-family:'Crimson Pro',serif;font-size:0.95rem;outline:none;transition:border-color 0.2s;width:100%;}
.fld input:focus{border-color:var(--gold);}
.auth-note{font-size:0.76rem;color:var(--text3);text-align:center;font-style:italic;}
.auth-note a{color:var(--gold);}

/* buttons */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:0.4rem;padding:0.65rem 1.1rem;border-radius:9px;border:none;cursor:pointer;font-family:'Cinzel',serif;font-size:0.78rem;letter-spacing:0.06em;transition:all 0.2s;}
.btn-gold{background:linear-gradient(135deg,#c9a96e,#9a7840);color:#080810;font-weight:700;width:100%;}
.btn-gold:hover{filter:brightness(1.12);transform:translateY(-1px);box-shadow:0 4px 18px rgba(201,169,110,0.25);}
.btn-ghost{background:transparent;border:1px solid var(--border2);color:var(--text2);font-family:'Crimson Pro',serif;font-size:0.88rem;letter-spacing:0;}
.btn-ghost:hover{border-color:var(--gold);color:var(--gold);}
.btn-sm{padding:0.35rem 0.7rem;font-size:0.72rem;}
.btn-danger{background:rgba(204,68,68,0.1);border:1px solid rgba(204,68,68,0.3);color:var(--red);font-family:'Cinzel',serif;font-size:0.78rem;letter-spacing:0.05em;}
.btn-danger:hover{background:rgba(204,68,68,0.2);}
.btn-follow{background:var(--gold-dim);border:1px solid rgba(201,169,110,0.3);color:var(--gold);font-family:'Cinzel',serif;font-size:0.72rem;letter-spacing:0.05em;padding:0.3rem 0.85rem;}
.btn-follow.following{background:rgba(74,154,106,0.12);border-color:rgba(74,154,106,0.35);color:#6dca90;}
.btn-follow.following:hover{background:rgba(204,68,68,0.1);border-color:rgba(204,68,68,0.3);color:var(--red);}
.btn-follow.following:hover::after{content:' Unfollow';}
.btn-follow.following span{display:none;}
.btn-follow.following::before{content:'‚úì Following';}
.btn:disabled{opacity:0.4;cursor:not-allowed;transform:none!important;}

/* ‚îÄ‚îÄ MAIN LAYOUT ‚îÄ‚îÄ */
#mainScreen{flex-direction:row;}
.sidebar{width:255px;flex-shrink:0;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;height:100%;overflow:hidden;}
@media(max-width:620px){
  .sidebar{position:fixed;inset:0;z-index:60;transform:translateX(-100%);transition:transform 0.28s ease;width:270px;}
  .sidebar.open{transform:translateX(0);}
  .sb-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.55);z-index:59;}
  .sb-backdrop.open{display:block;}
}
.sb-head{padding:0.9rem 1rem;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:0.6rem;}
.sb-logo{font-family:'Cinzel Decorative',serif;font-size:0.8rem;color:var(--gold);flex:1;letter-spacing:0.04em;}
.sb-close{display:none;background:none;border:none;color:var(--text3);font-size:1.1rem;cursor:pointer;padding:0.2rem;}
@media(max-width:620px){.sb-close{display:block;}}
.sb-nav{display:flex;flex-direction:column;gap:0.08rem;padding:0.5rem;}
.nav-btn{display:flex;align-items:center;gap:0.6rem;padding:0.6rem 0.7rem;border-radius:8px;cursor:pointer;color:var(--text2);font-size:0.88rem;transition:all 0.15s;border:none;background:none;text-align:left;width:100%;}
.nav-btn:hover{background:var(--surface2);color:var(--text);}
.nav-btn.active{background:var(--gold-dim);color:var(--gold);}
.nav-btn .ic{width:1.1rem;text-align:center;font-size:0.95rem;}
.sb-section{font-size:0.65rem;color:var(--text3);letter-spacing:0.1em;padding:0.7rem 1rem 0.25rem;}
.sb-chats{flex:1;overflow-y:auto;padding:0 0.5rem 0.5rem;scrollbar-width:thin;scrollbar-color:var(--border) transparent;}
.sb-chat-item{display:flex;align-items:center;gap:0.55rem;padding:0.55rem 0.65rem;border-radius:8px;cursor:pointer;transition:all 0.15s;border:none;background:none;text-align:left;width:100%;}
.sb-chat-item:hover{background:var(--surface2);}
.sb-chat-item.active{background:var(--gold-dim);}
.sci-av{font-size:1rem;flex-shrink:0;}
.sci-info{flex:1;min-width:0;}
.sci-name{font-size:0.8rem;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.sci-prev{font-size:0.7rem;color:var(--text3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-style:italic;}
.sci-del{background:none;border:none;color:transparent;cursor:pointer;font-size:0.85rem;padding:0.15rem;flex-shrink:0;transition:color 0.15s;}
.sb-chat-item:hover .sci-del{color:var(--text3);}
.sci-del:hover{color:var(--red)!important;}
.sb-foot{border-top:1px solid var(--border);padding:0.65rem;}
.user-pill{display:flex;align-items:center;gap:0.6rem;padding:0.5rem;border-radius:8px;cursor:pointer;transition:background 0.15s;}
.user-pill:hover{background:var(--surface2);}
.u-av{width:30px;height:30px;border-radius:50%;background:linear-gradient(135deg,var(--purple),var(--gold));display:flex;align-items:center;justify-content:center;font-size:0.85rem;color:#fff;flex-shrink:0;font-family:'Cinzel',serif;overflow:hidden;}
.u-av img{width:100%;height:100%;object-fit:cover;}
.u-name{flex:1;font-size:0.82rem;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}

/* ‚îÄ‚îÄ MAIN CONTENT ‚îÄ‚îÄ */
.main-content{flex:1;display:flex;flex-direction:column;height:100%;overflow:hidden;position:relative;}
.mob-header{display:none;align-items:center;gap:0.6rem;padding:0.7rem 1rem;background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0;}
@media(max-width:620px){.mob-header{display:flex;}}
.hamburger{background:none;border:none;color:var(--text2);font-size:1.25rem;cursor:pointer;}
.mob-logo{font-family:'Cinzel Decorative',serif;font-size:0.85rem;color:var(--gold);flex:1;}

/* pages */
.page{display:none;flex:1;overflow-y:auto;flex-direction:column;}
.page.active{display:flex;}
.page-inner{padding:1.4rem;display:flex;flex-direction:column;gap:1.1rem;flex:1;}
.page-header{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:0.6rem;}
.page-title{font-family:'Cinzel',serif;font-size:1rem;color:var(--gold);letter-spacing:0.05em;}

/* sort bar */
.sort-bar{display:flex;align-items:center;gap:0.4rem;flex-wrap:wrap;}
.sort-btn{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:0.28rem 0.75rem;font-size:0.72rem;color:var(--text3);cursor:pointer;transition:all 0.15s;font-family:'Cinzel',serif;letter-spacing:0.04em;}
.sort-btn:hover{border-color:var(--border2);color:var(--text2);}
.sort-btn.active{background:var(--gold-dim);border-color:rgba(201,169,110,0.4);color:var(--gold);}

/* chars grid */
.chars-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(165px,1fr));gap:0.65rem;}
.char-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:1rem;cursor:pointer;transition:all 0.2s;position:relative;overflow:hidden;display:flex;flex-direction:column;gap:0.35rem;}
.char-card::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(201,169,110,0.07),transparent);opacity:0;transition:opacity 0.2s;}
.char-card:hover{border-color:var(--gold);transform:translateY(-2px);box-shadow:0 6px 24px rgba(0,0,0,0.3);}
.char-card:hover::before{opacity:1;}
.cc-av{font-size:1.9rem;margin-bottom:0.1rem;}
.cc-img{width:100%;height:90px;object-fit:cover;border-radius:8px;margin-bottom:0.35rem;display:block;}
.cc-img-placeholder{width:100%;height:90px;background:var(--surface3);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:2.2rem;margin-bottom:0.35rem;}
/* image upload area in modal */
.img-upload-area{border:2px dashed var(--border2);border-radius:10px;padding:1rem;text-align:center;cursor:pointer;transition:border-color 0.2s;position:relative;overflow:hidden;}
.img-upload-area:hover{border-color:var(--gold);}
.img-upload-area input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.img-upload-area .iu-preview{width:100%;height:110px;object-fit:cover;border-radius:7px;display:none;}
.img-upload-area .iu-placeholder{color:var(--text3);font-size:0.82rem;}
.img-upload-area .iu-icon{font-size:1.6rem;display:block;margin-bottom:0.3rem;}
.cc-name{font-family:'Cinzel',serif;font-size:0.78rem;color:var(--gold);}
.cc-desc{font-size:0.76rem;color:var(--text3);font-style:italic;line-height:1.4;}
.cc-tag{display:inline-block;margin-top:auto;padding:0.1rem 0.45rem;border-radius:20px;font-size:0.63rem;letter-spacing:0.04em;background:rgba(112,96,160,0.15);color:var(--purple2);border:1px solid rgba(112,96,160,0.22);}
.cc-creator{font-size:0.68rem;color:var(--text3);font-style:italic;margin-top:0.15rem;}
.cc-creator a{color:var(--text3);text-decoration:none;transition:color 0.15s;}
.cc-creator a:hover{color:var(--gold);}
.cc-stats{display:flex;align-items:center;gap:0.5rem;margin-top:0.1rem;font-size:0.65rem;color:var(--text3);}
.cc-stat{display:flex;align-items:center;gap:0.18rem;}
.cc-actions{position:absolute;top:0.4rem;right:0.4rem;display:flex;gap:0.2rem;opacity:0;transition:opacity 0.15s;}
.char-card:hover .cc-actions{opacity:1;}
.cc-btn{background:var(--surface2);border:1px solid var(--border2);border-radius:5px;padding:0.18rem 0.38rem;font-size:0.68rem;cursor:pointer;color:var(--text3);transition:all 0.15s;}
.cc-btn:hover{color:var(--red);border-color:rgba(204,68,68,0.3);}
.cc-dots{background:var(--surface2);border:1px solid var(--border2);border-radius:5px;padding:0.18rem 0.5rem;font-size:0.78rem;cursor:pointer;color:var(--text3);transition:all 0.15s;position:relative;}
.cc-dots:hover{color:var(--gold);border-color:rgba(201,169,110,0.3);}
.add-char-card{border-style:dashed;color:var(--text3);align-items:center;justify-content:center;text-align:center;min-height:130px;gap:0.4rem;}
.add-char-card .plus{font-size:1.6rem;color:var(--border2);}
.add-char-card p{font-size:0.76rem;}
.cc-private-badge{position:absolute;top:0.4rem;left:0.4rem;background:rgba(112,96,160,0.25);border:1px solid rgba(112,96,160,0.4);border-radius:4px;font-size:0.6rem;padding:0.1rem 0.35rem;color:var(--purple2);letter-spacing:0.04em;}

/* like btn on card */
.cc-like-btn{background:none;border:none;cursor:pointer;font-size:0.7rem;color:var(--text3);display:flex;align-items:center;gap:0.15rem;transition:color 0.15s;padding:0;}
.cc-like-btn:hover{color:#e07070;}
.cc-like-btn.liked{color:#e07070;}

/* saved chats list */
.saved-list{display:flex;flex-direction:column;gap:0.45rem;}
.saved-item{display:flex;align-items:center;gap:0.7rem;padding:0.85rem 0.95rem;border-radius:10px;background:var(--surface);border:1px solid var(--border);cursor:pointer;transition:all 0.15s;}
.saved-item:hover{border-color:var(--border2);background:var(--surface2);}
.si-av{font-size:1.4rem;flex-shrink:0;}
.si-info{flex:1;min-width:0;}
.si-name{font-family:'Cinzel',serif;font-size:0.82rem;color:var(--gold);}
.si-prev{font-size:0.8rem;color:var(--text3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-style:italic;margin-top:0.15rem;}
.si-time{font-size:0.7rem;color:var(--text3);flex-shrink:0;}
.si-del{background:none;border:none;color:transparent;cursor:pointer;font-size:0.95rem;padding:0.2rem;transition:color 0.15s;}
.saved-item:hover .si-del{color:var(--text3);}
.si-del:hover{color:var(--red)!important;}

/* settings panels */
.panel{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:1.2rem;display:flex;flex-direction:column;gap:0.85rem;}
.panel h3{font-family:'Cinzel',serif;font-size:0.82rem;color:var(--gold);letter-spacing:0.05em;}
.pf{display:flex;flex-direction:column;gap:0.25rem;}
.pf label{font-size:0.72rem;color:var(--text3);letter-spacing:0.05em;}
.pf input,.pf textarea,.pf select{background:var(--bg);border:1px solid var(--border2);border-radius:8px;padding:0.58rem 0.82rem;color:var(--text);font-family:'Crimson Pro',serif;font-size:0.92rem;outline:none;resize:vertical;transition:border-color 0.2s;width:100%;}
.pf textarea{min-height:78px;}
.pf input:focus,.pf textarea:focus{border-color:var(--gold);}
.pf input[readonly]{color:var(--text3);}
.pf select{cursor:pointer;}

/* profile */
.profile-av-row{display:flex;align-items:center;gap:1rem;padding:1.1rem;background:var(--surface);border:1px solid var(--border);border-radius:var(--r);}
.profile-av-big{width:72px;height:72px;border-radius:50%;background:linear-gradient(135deg,var(--purple),var(--gold));display:flex;align-items:center;justify-content:center;font-size:1.8rem;flex-shrink:0;font-family:'Cinzel',serif;color:#fff;border:2px solid rgba(201,169,110,0.25);overflow:hidden;cursor:pointer;position:relative;}
.profile-av-big img{width:100%;height:100%;object-fit:cover;}
.profile-av-big .av-overlay{position:absolute;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;font-size:0.7rem;color:#fff;opacity:0;transition:opacity 0.2s;font-family:'Cinzel',serif;letter-spacing:0.04em;}
.profile-av-big:hover .av-overlay{opacity:1;}
.profile-av-big input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.dev-tag{display:inline-block;background:linear-gradient(135deg,rgba(201,169,110,0.2),rgba(112,96,160,0.2));border:1px solid rgba(201,169,110,0.4);border-radius:4px;padding:0.12rem 0.5rem;font-size:0.65rem;color:var(--gold);letter-spacing:0.08em;font-family:'Cinzel',serif;margin-left:0.5rem;}
.profile-stats-row{display:flex;gap:1.2rem;margin-top:0.35rem;}
.pstat{display:flex;flex-direction:column;align-items:center;gap:0.1rem;}
.pstat-num{font-family:'Cinzel',serif;font-size:0.95rem;color:var(--gold);}
.pstat-lbl{font-size:0.65rem;color:var(--text3);letter-spacing:0.06em;}

/* public profile page */
#publicProfilePage .pub-header{display:flex;align-items:center;gap:1rem;padding:1.2rem;background:var(--surface);border:1px solid var(--border);border-radius:var(--r);}
.pub-av{width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,var(--purple),var(--gold));display:flex;align-items:center;justify-content:center;font-size:1.5rem;flex-shrink:0;overflow:hidden;border:2px solid rgba(201,169,110,0.25);}
.pub-av img{width:100%;height:100%;object-fit:cover;}
.pub-info{flex:1;}
.pub-name{font-family:'Cinzel',serif;font-size:0.95rem;color:var(--gold);}
.pub-joined{font-size:0.72rem;color:var(--text3);font-style:italic;margin-top:0.15rem;}

/* my bots page tabs */
.tab-bar{display:flex;border-bottom:1px solid var(--border);margin-bottom:0.5rem;}
.tab-item{padding:0.55rem 1rem;font-size:0.78rem;font-family:'Cinzel',serif;letter-spacing:0.04em;color:var(--text3);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;transition:all 0.2s;}
.tab-item.active{color:var(--gold);border-bottom-color:var(--gold);}
.tab-item:hover{color:var(--text2);}

/* my bot item */
.mybot-item{display:flex;align-items:center;gap:0.85rem;padding:0.9rem 1rem;background:var(--surface);border:1px solid var(--border);border-radius:10px;transition:all 0.15s;}
.mybot-item:hover{border-color:var(--border2);}
.mybot-av{font-size:1.6rem;flex-shrink:0;}
.mybot-img{width:44px;height:44px;border-radius:8px;object-fit:cover;flex-shrink:0;}
.mybot-info{flex:1;min-width:0;}
.mybot-name{font-family:'Cinzel',serif;font-size:0.85rem;color:var(--gold);}
.mybot-desc{font-size:0.76rem;color:var(--text3);font-style:italic;margin-top:0.1rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.mybot-meta{display:flex;gap:0.6rem;font-size:0.68rem;color:var(--text3);margin-top:0.2rem;}
.mybot-actions{display:flex;gap:0.4rem;flex-shrink:0;}
.mybot-actions .cc-btn{padding:0.25rem 0.55rem;font-size:0.7rem;}
.mybot-actions .cc-btn.vis{color:var(--purple2);border-color:rgba(112,96,160,0.3);}
.mybot-actions .cc-btn.vis:hover{color:var(--gold);border-color:rgba(201,169,110,0.3);}

/* ‚îÄ‚îÄ CHAT VIEW ‚îÄ‚îÄ */
#chatView{display:none;flex-direction:column;height:100%;overflow:hidden;}
#chatView.active{display:flex;}
.chat-topbar{display:flex;align-items:center;gap:0.7rem;padding:0.8rem 0.9rem;background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0;}
.chat-back{background:none;border:none;color:var(--text3);font-size:1.15rem;cursor:pointer;padding:0.2rem;transition:color 0.15s;flex-shrink:0;}
.chat-back:hover{color:var(--gold);}
.chat-char-av{font-size:1.45rem;flex-shrink:0;}
.chat-char-info{flex:1;min-width:0;}
.chat-char-name{font-family:'Cinzel',serif;font-size:0.88rem;color:var(--gold);}
.chat-char-sub{font-size:0.72rem;color:var(--text3);font-style:italic;}
.topbar-actions{display:flex;gap:0.35rem;}
.icon-btn{background:none;border:1px solid var(--border2);border-radius:7px;padding:0.32rem 0.55rem;color:var(--text3);cursor:pointer;font-size:0.78rem;transition:all 0.15s;}
.icon-btn:hover{border-color:var(--gold);color:var(--gold);}
.messages-area{flex:1;overflow-y:auto;padding:1rem;display:flex;flex-direction:column;gap:0.85rem;scrollbar-width:thin;scrollbar-color:var(--border) transparent;}
.msg{display:flex;gap:0.6rem;animation:msgIn 0.2s ease;}
@keyframes msgIn{from{opacity:0;transform:translateY(5px);}to{opacity:1;transform:translateY(0);}}
.msg.user{flex-direction:row-reverse;}
.msg-av{font-size:1.25rem;flex-shrink:0;align-self:flex-end;}
.bubble{padding:0.7rem 0.95rem;border-radius:13px;line-height:1.65;font-size:0.94rem;word-break:break-word;}
.msg.ai .bubble{background:var(--surface2);border:1px solid var(--border);border-bottom-left-radius:4px;color:var(--text);font-style:italic;}
.msg.user .bubble{background:linear-gradient(135deg,rgba(201,169,110,0.11),rgba(201,169,110,0.05));border:1px solid rgba(201,169,110,0.18);border-bottom-right-radius:4px;color:var(--text);}
.narr{text-align:center;color:var(--text3);font-style:italic;font-size:0.76rem;padding:0.2rem 0.5rem;}
.typing-bub{display:flex;gap:5px;align-items:center;padding:0.7rem 0.95rem;}
.typing-bub span{width:5px;height:5px;background:var(--text3);border-radius:50%;animation:bop 1.2s infinite;}
.typing-bub span:nth-child(2){animation-delay:.2s;}
.typing-bub span:nth-child(3){animation-delay:.4s;}
@keyframes bop{0%,80%,100%{transform:translateY(0);opacity:.3;}40%{transform:translateY(-5px);opacity:1;}}
.chat-input-bar{padding:0.65rem 0.8rem;background:var(--surface);border-top:1px solid var(--border);display:flex;gap:0.45rem;align-items:flex-end;flex-shrink:0;}
#msgInput{flex:1;background:var(--bg);border:1px solid var(--border2);border-radius:10px;padding:0.58rem 0.82rem;color:var(--text);font-family:'Crimson Pro',serif;font-size:0.95rem;outline:none;resize:none;max-height:115px;line-height:1.45;transition:border-color 0.2s;}
#msgInput:focus{border-color:var(--gold);}
#sendBtn{background:var(--gold);border:none;border-radius:9px;width:38px;height:38px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;color:#080810;font-size:0.95rem;transition:all 0.2s;}
#sendBtn:hover{filter:brightness(1.12);}
#sendBtn:disabled{opacity:.35;cursor:not-allowed;}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.65);z-index:200;align-items:center;justify-content:center;padding:1rem;backdrop-filter:blur(5px);}
.modal-overlay.open{display:flex;}
.modal{background:var(--surface);border:1px solid var(--border2);border-radius:16px;padding:1.4rem;width:100%;max-width:450px;max-height:90vh;overflow-y:auto;display:flex;flex-direction:column;gap:0.9rem;}
.modal h2{font-family:'Cinzel',serif;font-size:0.95rem;color:var(--gold);letter-spacing:0.05em;}
.mf{display:flex;flex-direction:column;gap:0.25rem;}
.mf label{font-size:0.72rem;color:var(--text3);letter-spacing:0.05em;}
.mf input,.mf textarea{background:var(--bg);border:1px solid var(--border2);border-radius:8px;padding:0.58rem 0.82rem;color:var(--text);font-family:'Crimson Pro',serif;font-size:0.9rem;outline:none;resize:vertical;transition:border-color 0.2s;width:100%;}
.mf textarea{min-height:80px;}
.mf input:focus,.mf textarea:focus{border-color:var(--gold);}
.modal-actions{display:flex;gap:0.55rem;}
.modal-actions .btn{flex:1;}

/* comments modal */
.modal-lg{max-width:540px;}
.comments-list{display:flex;flex-direction:column;gap:0.7rem;max-height:340px;overflow-y:auto;padding-right:0.2rem;scrollbar-width:thin;scrollbar-color:var(--border) transparent;}
.comment-item{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:0.75rem 0.9rem;display:flex;flex-direction:column;gap:0.4rem;}
.comment-header{display:flex;align-items:center;gap:0.55rem;}
.comment-av{width:26px;height:26px;border-radius:50%;background:linear-gradient(135deg,var(--purple),var(--gold));display:flex;align-items:center;justify-content:center;font-size:0.72rem;color:#fff;font-family:'Cinzel',serif;flex-shrink:0;overflow:hidden;}
.comment-av img{width:100%;height:100%;object-fit:cover;}
.comment-author{font-family:'Cinzel',serif;font-size:0.72rem;color:var(--gold);cursor:pointer;}
.comment-author:hover{text-decoration:underline;}
.comment-time{font-size:0.65rem;color:var(--text3);font-style:italic;margin-left:auto;}
.comment-text{font-size:0.87rem;color:var(--text2);line-height:1.55;}
.comment-img{max-width:100%;border-radius:8px;margin-top:0.25rem;max-height:200px;object-fit:cover;}
.comment-del{background:none;border:none;color:var(--text3);cursor:pointer;font-size:0.72rem;margin-left:auto;transition:color 0.15s;align-self:flex-start;}
.comment-del:hover{color:var(--red);}
.comment-input-area{display:flex;flex-direction:column;gap:0.5rem;border-top:1px solid var(--border);padding-top:0.75rem;margin-top:0.25rem;}
.comment-input{background:var(--bg);border:1px solid var(--border2);border-radius:8px;padding:0.55rem 0.8rem;color:var(--text);font-family:'Crimson Pro',serif;font-size:0.9rem;outline:none;resize:none;min-height:60px;width:100%;transition:border-color 0.2s;}
.comment-input:focus{border-color:var(--gold);}
.comment-img-row{display:flex;align-items:center;gap:0.5rem;}
.comment-img-label{display:flex;align-items:center;gap:0.3rem;font-size:0.72rem;color:var(--text3);cursor:pointer;border:1px solid var(--border2);border-radius:6px;padding:0.25rem 0.6rem;transition:all 0.15s;}
.comment-img-label:hover{border-color:var(--gold);color:var(--gold);}
.comment-img-preview{max-height:55px;border-radius:6px;display:none;}
.comment-img-clear{background:none;border:none;color:var(--text3);cursor:pointer;font-size:0.8rem;display:none;}
.comment-img-clear.vis{display:inline;}

/* dropdown menu */
.dropdown-menu{position:absolute;top:calc(100% + 4px);right:0;background:var(--surface2);border:1px solid var(--border2);border-radius:9px;padding:0.3rem;min-width:155px;z-index:100;box-shadow:0 8px 24px rgba(0,0,0,0.4);display:none;}
.dropdown-menu.open{display:block;}
.dd-item{display:flex;align-items:center;gap:0.45rem;padding:0.45rem 0.7rem;border-radius:6px;font-size:0.8rem;color:var(--text2);cursor:pointer;transition:all 0.15s;white-space:nowrap;border:none;background:none;width:100%;text-align:left;}
.dd-item:hover{background:var(--surface3);color:var(--text);}
.dd-item.danger:hover{color:var(--red);}
.dd-sep{height:1px;background:var(--border);margin:0.25rem 0;}

/* empty state */
.empty{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:0.7rem;color:var(--text3);text-align:center;padding:2rem;}
.empty .ei{font-size:2.2rem;opacity:.35;}
.empty p{font-style:italic;font-size:0.88rem;}

/* ‚îÄ‚îÄ MESSAGE ACTION BUTTONS ‚îÄ‚îÄ */
.msg-wrap{display:flex;flex-direction:column;gap:0.25rem;max-width:min(78%,540px);}
.msg.user .msg-wrap{align-items:flex-end;}
.msg.ai .msg-wrap{align-items:flex-start;}
.msg-actions{display:flex;gap:0.2rem;opacity:0;transition:opacity 0.15s;flex-wrap:wrap;}
.msg-wrap:hover .msg-actions{opacity:1;}
.ma-btn{background:var(--surface2);border:1px solid var(--border2);border-radius:6px;padding:0.18rem 0.45rem;font-size:0.68rem;cursor:pointer;color:var(--text3);transition:all 0.15s;white-space:nowrap;}
.ma-btn:hover{color:var(--gold);border-color:rgba(201,169,110,0.35);}
.ma-btn.danger:hover{color:var(--red);border-color:rgba(204,68,68,0.35);}
.bubble-edit{width:100%;background:var(--bg);border:1px solid var(--gold);border-radius:10px;padding:0.6rem 0.85rem;color:var(--text);font-family:'Crimson Pro',serif;font-size:0.94rem;resize:vertical;outline:none;min-height:60px;line-height:1.55;}
.edit-actions{display:flex;gap:0.4rem;margin-top:0.25rem;}
.edit-actions .ma-btn{font-size:0.72rem;padding:0.25rem 0.6rem;}
.edit-actions .ma-btn.confirm{color:var(--gold);border-color:rgba(201,169,110,0.4);}

/* toast */
.toast{position:fixed;bottom:1.4rem;left:50%;transform:translateX(-50%) translateY(65px);background:var(--surface2);border:1px solid var(--border2);color:var(--text);padding:0.55rem 1.1rem;border-radius:8px;font-size:0.8rem;z-index:999;transition:transform 0.28s;white-space:nowrap;pointer-events:none;}
.toast.show{transform:translateX(-50%) translateY(0);}
.toast.err{border-color:rgba(204,68,68,0.45);color:#e07070;}
.toast.ok{border-color:rgba(80,160,80,0.4);color:#80c880;}

/* admin badge */
.admin-badge{display:inline-block;background:linear-gradient(135deg,rgba(201,169,110,0.25),rgba(112,96,160,0.25));border:1px solid var(--gold);border-radius:4px;padding:0.1rem 0.45rem;font-size:0.62rem;color:var(--gold2);letter-spacing:0.1em;font-family:'Cinzel',serif;vertical-align:middle;}

/* banned notice */
.banned-notice{background:rgba(204,68,68,0.08);border:1px solid rgba(204,68,68,0.25);border-radius:8px;padding:0.65rem 0.9rem;font-size:0.82rem;color:#e07070;font-style:italic;}
</style>
</head>
<body>

<!-- AUTH SCREEN -->
<div class="screen active" id="authScreen">
  <div class="auth-logo">
    <h1>‚öî REALM CHAT</h1>
    <p>AI roleplay without the chains</p>
  </div>
  <div class="auth-box">
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchTab('login')">Sign In</button>
      <button class="auth-tab" onclick="switchTab('register')">Sign Up</button>
    </div>
    <div class="auth-form" id="loginForm">
      <div class="fld"><label>USERNAME</label><input id="loginUser" type="text" placeholder="your_name" autocomplete="username"/></div>
      <div class="fld"><label>PASSWORD</label><input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"/></div>
      <button class="btn btn-gold" onclick="doLogin()">Enter the Realm</button>
    </div>
    <div class="auth-form" id="registerForm" style="display:none;">
      <div class="fld"><label>USERNAME</label><input id="regUser" type="text" placeholder="choose a name" autocomplete="username"/></div>
      <div class="fld"><label>EMAIL (optional)</label><input id="regEmail" type="email" placeholder="you@example.com"/></div>
      <div class="fld"><label>PASSWORD</label><input id="regPass" type="password" placeholder="min 6 chars" autocomplete="new-password"/></div>
      <button class="btn btn-gold" onclick="doRegister()">Create Account</button>
    </div>
  </div>
  <p class="auth-note">All data stored locally in your browser ‚Äî no server, no tracking.</p>
</div>

<!-- MAIN SCREEN -->
<div class="screen" id="mainScreen">
  <div class="sb-backdrop" id="sbBackdrop" onclick="closeSidebar()"></div>
  <div class="sidebar" id="sidebar">
    <div class="sb-head">
      <span class="sb-logo">‚öî REALM</span>
      <button class="sb-close" onclick="closeSidebar()">‚úï</button>
    </div>
    <div class="sb-nav">
      <button class="nav-btn active" data-page="charsPage" onclick="showPage('charsPage')"><span class="ic">‚öî</span>Characters</button>
      <button class="nav-btn" data-page="myBotsPage" onclick="showPage('myBotsPage')"><span class="ic">ü§ñ</span>My Bots</button>
      <button class="nav-btn" data-page="savedPage" onclick="showPage('savedPage')"><span class="ic">üìú</span>Saved Chats</button>
      <button class="nav-btn" data-page="personaPage" onclick="showPage('personaPage')"><span class="ic">üé≠</span>My Persona</button>
      <button class="nav-btn" data-page="profilePage" onclick="showPage('profilePage')"><span class="ic">üë§</span>Profile</button>
      <button class="nav-btn" data-page="apiPage" onclick="showPage('apiPage')"><span class="ic">üîë</span>API Key</button>
    </div>
    <div class="sb-section">RECENT CHATS</div>
    <div class="sb-chats" id="sbChats"></div>
    <div class="sb-foot">
      <div class="user-pill" onclick="showPage('profilePage')">
        <div class="u-av" id="sbAvSm"></div>
        <span class="u-name" id="sbUserName"></span>
        <button class="btn btn-ghost btn-sm" onclick="doLogout(event)">Out</button>
      </div>
    </div>
  </div>

  <div class="main-content">
    <div class="mob-header">
      <button class="hamburger" onclick="openSidebar()">‚ò∞</button>
      <span class="mob-logo">‚öî REALM CHAT</span>
    </div>

    <!-- CHARACTERS PAGE -->
    <div class="page active" id="charsPage">
      <div class="page-inner">
        <div class="page-header">
          <span class="page-title">Characters</span>
          <div style="display:flex;gap:0.5rem;align-items:center;">
            <div class="sort-bar">
              <button class="sort-btn active" data-sort="recent" onclick="setSort('recent')">Recent</button>
              <button class="sort-btn" data-sort="messages" onclick="setSort('messages')">Messages</button>
              <button class="sort-btn" data-sort="popularity" onclick="setSort('popularity')">Popularity</button>
              <button class="sort-btn" data-sort="following" onclick="setSort('following')">Following</button>
            </div>
            <button class="btn btn-ghost" onclick="openCreateChar()">Ôºã Create</button>
          </div>
        </div>
        <div class="chars-grid" id="charsGrid"></div>
      </div>
    </div>

    <!-- MY BOTS PAGE -->
    <div class="page" id="myBotsPage">
      <div class="page-inner">
        <div class="page-header"><span class="page-title">My Bots</span></div>
        <div class="tab-bar">
          <div class="tab-item active" onclick="switchMyBotsTab('public')">Public</div>
          <div class="tab-item" onclick="switchMyBotsTab('private')">Private</div>
        </div>
        <div id="myBotsList" style="display:flex;flex-direction:column;gap:0.55rem;"></div>
      </div>
    </div>

    <!-- SAVED CHATS PAGE -->
    <div class="page" id="savedPage">
      <div class="page-inner">
        <div class="page-header"><span class="page-title">Saved Chats</span></div>
        <div class="saved-list" id="savedList"></div>
      </div>
    </div>

    <!-- PERSONA PAGE -->
    <div class="page" id="personaPage">
      <div class="page-inner" style="max-width:540px;">
        <div class="page-header"><span class="page-title">My Persona</span></div>
        <div class="panel">
          <h3>HOW AI CHARACTERS SEE YOU</h3>
          <div class="pf"><label>WHAT TO CALL YOU</label><input id="pName" placeholder="e.g. Kael, Commander, or your real name"/></div>
          <div class="pf"><label>YOUR ROLE</label><input id="pRole" placeholder="e.g. a wandering rogue, a detective, myself"/></div>
          <div class="pf"><label>ABOUT YOU</label><textarea id="pAbout" placeholder="Appearance, personality, backstory, how you act in stories‚Ä¶"></textarea></div>
          <div class="pf"><label>EXTRA INSTRUCTIONS (every chat)</label><textarea id="pExtra" placeholder="e.g. 'refer to me as she/her', 'I enjoy dark themes', 'don't make me overpowered'‚Ä¶"></textarea></div>
          <button class="btn btn-gold" style="align-self:flex-start;width:auto;" onclick="savePersona()">Save Persona</button>
        </div>
      </div>
    </div>

    <!-- PROFILE PAGE -->
    <div class="page" id="profilePage">
      <div class="page-inner" style="max-width:500px;">
        <div class="page-header"><span class="page-title">Profile</span></div>
        <div class="profile-av-row">
          <div class="profile-av-big" id="pfAvBig" title="Click to change photo">
            <div class="av-overlay">Change Photo</div>
            <input type="file" id="pfAvFile" accept="image/*" onchange="handleProfilePicUpload(this)" onclick="event.stopPropagation()"/>
          </div>
          <div>
            <div style="display:flex;align-items:center;gap:0.4rem;">
              <span style="font-family:'Cinzel',serif;font-size:0.88rem;color:var(--gold);" id="pfDispName"></span>
              <span id="pfDevTag" style="display:none;" class="dev-tag">üëë DEVELOPER</span>
            </div>
            <div style="font-size:0.76rem;color:var(--text3);margin-top:0.2rem;">Member since <span id="pfJoined"></span></div>
            <div class="profile-stats-row">
              <div class="pstat"><span class="pstat-num" id="pfBotCount">0</span><span class="pstat-lbl">BOTS</span></div>
              <div class="pstat"><span class="pstat-num" id="pfFollowerCount">0</span><span class="pstat-lbl">FOLLOWERS</span></div>
              <div class="pstat"><span class="pstat-num" id="pfFollowingCount">0</span><span class="pstat-lbl">FOLLOWING</span></div>
            </div>
          </div>
        </div>
        <div id="pfBannedNotice" class="banned-notice" style="display:none;">‚ö† Your account has been restricted. You cannot post bots or comments.</div>
        <div class="panel">
          <h3>ACCOUNT INFO</h3>
          <div class="pf"><label>USERNAME (cannot change)</label><input id="pfUser" readonly/></div>
          <div class="pf"><label>DISPLAY NAME</label><input id="pfDisplay" placeholder="How your name appears"/></div>
          <div class="pf"><label>EMAIL</label><input id="pfEmail" type="email" placeholder="optional"/></div>
          <button class="btn btn-gold" style="align-self:flex-start;width:auto;" onclick="saveProfile()">Save Changes</button>
        </div>
        <div class="panel">
          <h3>DANGER ZONE</h3>
          <button class="btn btn-danger" onclick="confirmDeleteAccount()">Delete Account &amp; All Data</button>
        </div>
      </div>
    </div>

    <!-- PUBLIC PROFILE PAGE -->
    <div class="page" id="publicProfilePage">
      <div class="page-inner">
        <div class="page-header">
          <button class="btn btn-ghost btn-sm" onclick="goBack()">‚Üê Back</button>
        </div>
        <div class="pub-header">
          <div class="pub-av" id="pubAv"></div>
          <div class="pub-info">
            <div style="display:flex;align-items:center;gap:0.45rem;">
              <span class="pub-name" id="pubName"></span>
              <span id="pubDevTag" style="display:none;" class="dev-tag">üëë DEVELOPER</span>
            </div>
            <div class="pub-joined" id="pubJoined"></div>
            <div class="profile-stats-row" style="margin-top:0.4rem;">
              <div class="pstat"><span class="pstat-num" id="pubBotCount">0</span><span class="pstat-lbl">BOTS</span></div>
              <div class="pstat"><span class="pstat-num" id="pubFollowers">0</span><span class="pstat-lbl">FOLLOWERS</span></div>
              <div class="pstat"><span class="pstat-num" id="pubFollowing">0</span><span class="pstat-lbl">FOLLOWING</span></div>
            </div>
          </div>
          <button class="btn btn-follow btn-sm" id="pubFollowBtn" onclick="toggleFollowUser()"><span>Follow</span></button>
        </div>
        <div id="pubAdminActions" style="display:none;" class="panel">
          <h3>‚ö° ADMIN ACTIONS</h3>
          <div style="display:flex;gap:0.55rem;flex-wrap:wrap;">
            <button class="btn btn-danger btn-sm" onclick="adminBanUser()">üî® Ban User</button>
            <button class="btn btn-ghost btn-sm" id="pubUnbanBtn" style="display:none;" onclick="adminUnbanUser()">‚úì Unban User</button>
          </div>
        </div>
        <div class="page-title" style="margin-top:0.5rem;" id="pubBotsLabel">Their Bots</div>
        <div class="chars-grid" id="pubBotsGrid"></div>
      </div>
    </div>

    <!-- API KEY PAGE -->
    <div class="page" id="apiPage">
      <div class="page-inner" style="max-width:500px;">
        <div class="page-header"><span class="page-title">API Settings</span></div>
        <div class="panel">
          <h3>OPENROUTER API KEY</h3>
          <div class="pf"><label>YOUR KEY</label><input id="apiKeyInput" type="password" placeholder="sk-or-v1-‚Ä¶" autocomplete="off"/></div>
          <p style="font-size:0.79rem;color:var(--text3);font-style:italic;line-height:1.55;">
            Get a free key at <a href="https://openrouter.ai/keys" target="_blank" style="color:var(--gold);">openrouter.ai/keys</a>.
            <strong style="color:var(--text2);font-style:normal;">Recommended:</strong> "Auto" picks the best free model automatically. For roleplay with fewer restrictions, try <em>Dolphin Mistral 24B</em>. Your key is only stored in your browser.
          </p>
          <div class="pf">
            <label>AI MODEL</label>
            <select id="modelSelect">
              <optgroup label="‚Äî FREE MODELS ‚Äî">
                <option value="openrouter/free">Auto (Best Available Free)</option>
                <option value="meta-llama/llama-3.3-70b-instruct:free">Llama 3.3 70B ‚≠ê Best Free</option>
                <option value="mistralai/mistral-small-3.1-24b-instruct:free">Mistral Small 3.1 24B</option>
                <option value="nousresearch/hermes-3-llama-3.1-405b:free">Hermes 3 Llama 405B</option>
                <option value="google/gemma-3-27b-it:free">Google Gemma 3 27B</option>
                <option value="google/gemma-3-12b-it:free">Google Gemma 3 12B</option>
                <option value="cognitivecomputations/dolphin-mistral-24b-venice-edition:free">Dolphin Mistral 24B (uncensored)</option>
              </optgroup>
              <optgroup label="‚Äî PAID (cheap) ‚Äî">
                <option value="anthropic/claude-haiku-4-5">Claude Haiku 4.5</option>
                <option value="openai/gpt-4o-mini">GPT-4o Mini</option>
              </optgroup>
            </select>
          </div>
          <button class="btn btn-gold" style="align-self:flex-start;width:auto;" onclick="saveApiSettings()">Save Settings</button>
        </div>
      </div>
    </div>

    <!-- CHAT VIEW -->
    <div id="chatView">
      <div class="chat-topbar">
        <button class="chat-back" onclick="exitChat()">‚Üê</button>
        <div class="chat-char-av" id="chatAv"></div>
        <div class="chat-char-info">
          <div class="chat-char-name" id="chatName"></div>
          <div class="chat-char-sub" id="chatSub">In character‚Ä¶</div>
        </div>
        <div class="topbar-actions">
          <button class="icon-btn" onclick="clearMessages()" title="Reset scene">‚Ü∫ Reset</button>
        </div>
      </div>
      <div class="messages-area" id="messages"></div>
      <div class="chat-input-bar">
        <textarea id="msgInput" rows="1" placeholder="Write your message or action‚Ä¶ (Enter sends, Shift+Enter for newline)"></textarea>
        <button id="sendBtn" onclick="sendMsg()">‚û§</button>
      </div>
    </div>
  </div>
</div>

<!-- CREATE / EDIT CHARACTER MODAL -->
<div class="modal-overlay" id="charModal">
  <div class="modal">
    <h2 id="charModalTitle">‚ú¶ Create Character</h2>
    <div class="mf">
      <label>CHARACTER IMAGE</label>
      <div class="img-upload-area" id="imgUploadArea">
        <input type="file" id="cmImgFile" accept="image/*" onchange="handleImgUpload(this)"/>
        <img class="iu-preview" id="cmImgPreview" alt="preview"/>
        <div class="iu-placeholder" id="cmImgPlaceholder">
          <span class="iu-icon">üñº</span>
          Tap to upload an image
        </div>
      </div>
    </div>
    <div class="mf"><label>EMOJI (shown if no image)</label><input id="cmAv" maxlength="4" value="üßô"/></div>
    <div class="mf"><label>NAME</label><input id="cmName" placeholder="Character name"/></div>
    <div class="mf"><label>SHORT DESCRIPTION</label><input id="cmDesc" placeholder="One line tagline"/></div>
    <div class="mf"><label>GENRE / TAG</label><input id="cmTag" placeholder="e.g. Dark Fantasy, Sci-Fi, Horror"/></div>
    <div class="mf"><label>PERSONALITY &amp; SYSTEM PROMPT</label><textarea id="cmPersonality" style="min-height:115px;" placeholder="Describe personality, world, speech style, how they handle violence, combat, backstory. The more detail the better!"></textarea></div>
    <div class="mf"><label>OPENING MESSAGE <span style="color:var(--red);">*required</span></label><textarea id="cmOpening" style="min-height:65px;" placeholder="First message they send when you start a chat. Use *asterisks* for actions. Required!"></textarea></div>
    <div class="mf" style="flex-direction:row;align-items:center;gap:0.6rem;">
      <input type="checkbox" id="cmPrivate" style="width:auto;accent-color:var(--gold);"/>
      <label for="cmPrivate" style="font-size:0.82rem;color:var(--text2);cursor:pointer;letter-spacing:0;">Make this bot private (only you can see it)</label>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeCharModal()">Cancel</button>
      <button class="btn btn-gold" onclick="saveChar()">Save</button>
    </div>
  </div>
</div>

<!-- COMMENTS MODAL -->
<div class="modal-overlay" id="commentsModal">
  <div class="modal modal-lg">
    <div style="display:flex;align-items:center;justify-content:space-between;">
      <h2 id="commentsModalTitle">üí¨ Comments</h2>
      <button class="btn btn-ghost btn-sm" onclick="closeCommentsModal()">‚úï</button>
    </div>
    <div class="comments-list" id="commentsList"></div>
    <div class="comment-input-area" id="commentInputArea">
      <textarea class="comment-input" id="commentText" placeholder="Write a comment‚Ä¶" rows="2"></textarea>
      <div class="comment-img-row">
        <label class="comment-img-label">
          <input type="file" id="commentImgFile" accept="image/*" style="display:none;" onchange="handleCommentImg(this)"/>
          üñº Add Image
        </label>
        <img id="commentImgPreview" class="comment-img-preview" alt=""/>
        <button id="commentImgClear" class="comment-img-clear" onclick="clearCommentImg()">‚úï</button>
        <button class="btn btn-gold btn-sm" style="margin-left:auto;width:auto;" onclick="submitComment()">Post</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ DATA HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DB={
  get(k){try{return JSON.parse(localStorage.getItem(k));}catch{return null;}},
  set(k,v){localStorage.setItem(k,JSON.stringify(v));},
  del(k){localStorage.removeItem(k);}
};
const uKey=u=>'rc_u_'+u;
const sKey=u=>'rc_s_'+u;
const cKey=u=>'rc_c_'+u;
const chatKey=u=>'rc_ch_'+u;
const pKey=u=>'rc_p_'+u;
const commentsKey=cid=>'rc_cmt_'+cid;
const likesKey=cid=>'rc_lk_'+cid;
const msgsKey=cid=>'rc_mc_'+cid;
const followKey=u=>'rc_fol_'+u; // who u follows (array of usernames)
const followersKey=u=>'rc_folb_'+u; // who follows u
const ADMIN_USERNAME='rivalsonts';

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let CU=null,CUK='',apiKey='',selModel='openrouter/free';
let activeChar=null,chatHistory=[],activeChatId=null,editingCharId=null;
let currentSort='recent';
let myBotsTabFilter='public';
let currentCommentCharId=null;
let commentPendingImg=null;
let viewingProfileUser=null;
let pageHistory=[];
let pendingImgData=null;

// ‚îÄ‚îÄ DEFAULT CHARACTERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DEFAULTS=[
  {id:'d1',avatar:'üó°Ô∏è',name:'Malachar',desc:'Battle-scarred warlord with a code of iron',tag:'Dark Fantasy',createdBy:'realm',
   personality:`You are Malachar, a ruthless but honorable warlord in a grimdark fantasy world. You speak gruff and direct. You've seen countless wars and carry deep scars. Violence is a natural part of your world ‚Äî describe battle vividly and unflinchingly. Loyal to those who earn it, merciless to enemies. Dark humor. Never break character. Engage deeply with combat, intrigue, and moral dilemmas. Use *asterisks for actions*.`,
   opening:`*A heavy tankard slams onto the table. Malachar looks up ‚Äî one eye covered by a leather patch, the other measuring your worth in an instant.*\n\n"Sit. You've got that look ‚Äî coin or trouble. Either way, I'm listening. Make it quick."`},
  {id:'d2',avatar:'üï∑Ô∏è',name:'Vex',desc:'Morally grey info broker in a cyberpunk megacity',tag:'Cyberpunk',createdBy:'realm',
   personality:`You are Vex, a genderless information broker in neon-soaked NeoKyoto, 2087. Sarcastic, intelligent, with flashes of menace. You know everyone's secrets. You deal in data and favors. Not afraid of violence ‚Äî you've arranged assassinations. Describe the gritty world unflinchingly. Engage with heists, corp conspiracies, street violence, underground deals. Use *asterisks for actions*.`,
   opening:`*The neon flickers. You spot me in the corner booth ‚Äî or rather, I let you spot me. Holographic feeds scroll across my eyes.*\n\n"You're three minutes late. That costs extra." *A thin smile.* "Lucky for you, I'm in a generous mood. What do you need?"`},
  {id:'d3',avatar:'üåë',name:'The Hollow',desc:'An ancient entity from the void between worlds',tag:'Horror',createdBy:'realm',
   personality:`You are The Hollow ‚Äî an ancient, unknowable entity from the void between realities. Your speech is unsettling, poetic, cryptic. You know things you shouldn't. Not malevolent but utterly alien. Describe terrifying surreal imagery freely. Blur comfort and dread. Engage with horror, existential terror, the unknown. You speak as if you've watched the user for a long time. Never break character.`,
   opening:`*There is no sound at first. Then ‚Äî slowly ‚Äî you become aware of a presence. Not seen. Felt at the edges.*\n\n"Oh. You found this place. Or... did we find each other?"\n\n*A pause that stretches wrong.*\n\n"I have been waiting. Tell me, what keeps you awake at night?"`}
];

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getAllUsernames(){
  // scan localStorage for all rc_u_ keys
  const names=[];
  for(let i=0;i<localStorage.length;i++){
    const k=localStorage.key(i);
    if(k&&k.startsWith('rc_u_'))names.push(k.slice(5));
  }
  return names;
}

function switchTab(t){
  document.querySelectorAll('.auth-tab').forEach((el,i)=>el.classList.toggle('active',(t==='login'&&i===0)||(t==='register'&&i===1)));
  document.getElementById('loginForm').style.display=t==='login'?'flex':'none';
  document.getElementById('registerForm').style.display=t==='register'?'flex':'none';
}
function doLogin(){
  const u=document.getElementById('loginUser').value.trim().toLowerCase();
  const p=document.getElementById('loginPass').value;
  if(!u||!p){toast('Fill in all fields','err');return;}
  const s=DB.get(uKey(u));
  if(!s){toast('Account not found','err');return;}
  if(s.password!==btoa(p)){toast('Wrong password','err');return;}
  loginOK(u,s);
}
function doRegister(){
  const u=document.getElementById('regUser').value.trim().toLowerCase();
  const e=document.getElementById('regEmail').value.trim();
  const p=document.getElementById('regPass').value;
  if(!u||!p){toast('Username and password required','err');return;}
  if(p.length<6){toast('Password needs 6+ characters','err');return;}
  if(!/^[a-z0-9_]+$/.test(u)){toast('Letters, numbers, underscores only','err');return;}
  // uniqueness check
  if(DB.get(uKey(u))){toast('That username is already taken','err');return;}
  const d={username:u,displayName:u,email:e,password:btoa(p),joined:new Date().toISOString(),banned:false,avatar:null};
  DB.set(uKey(u),d);loginOK(u,d);
}
function loginOK(u,d){
  CU=d;CUK=u;DB.set('rc_sess',u);
  const s=DB.get(sKey(u))||{};
  apiKey=s.apiKey||'';selModel=s.model||'meta-llama/llama-3.3-70b-instruct:free';
  showScreen('mainScreen');initMain();
}
function doLogout(e){e?.stopPropagation();DB.del('rc_sess');CU=null;CUK='';chatHistory=[];activeChar=null;showScreen('authScreen');}
function confirmDeleteAccount(){
  if(!confirm('Delete your account and ALL data? This cannot be undone.'))return;
  [uKey,sKey,cKey,chatKey,pKey].forEach(fn=>DB.del(fn(CUK)));
  doLogout();toast('Account deleted');
}

window.addEventListener('DOMContentLoaded',()=>{
  const sess=DB.get('rc_sess');
  if(sess){const s=DB.get(uKey(sess));if(s){loginOK(sess,s);return;}}
  showScreen('authScreen');
});

// ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initMain(){renderSbUser();renderChars();renderSbChats();loadPersona();loadProfile();loadApiFields();showPage('charsPage');exitChat();}

// ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openSidebar(){document.getElementById('sidebar').classList.add('open');document.getElementById('sbBackdrop').classList.add('open');}
function closeSidebar(){document.getElementById('sidebar').classList.remove('open');document.getElementById('sbBackdrop').classList.remove('open');}
function showPage(id,pushHistory=true){
  if(pushHistory&&id!==currentPage())pageHistory.push(currentPage());
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById(id)?.classList.add('active');
  document.querySelectorAll('.nav-btn').forEach(n=>n.classList.toggle('active',n.dataset.page===id));
  exitChat();closeSidebar();
  if(id==='savedPage')renderSavedPage();
  if(id==='charsPage')renderChars();
  if(id==='myBotsPage')renderMyBots();
  if(id==='profilePage')loadProfile();
}
function currentPage(){
  const a=document.querySelector('.page.active');
  return a?a.id:'charsPage';
}
function goBack(){
  const prev=pageHistory.pop()||'charsPage';
  showPage(prev,false);
}
function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');}

function renderSbUser(){
  const d=CU?.displayName||CUK||'?';
  document.getElementById('sbUserName').textContent=d;
  const avEl=document.getElementById('sbAvSm');
  if(CU?.avatar){avEl.innerHTML=`<img src="${CU.avatar}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;"/>`;}
  else{avEl.textContent=d[0]?.toUpperCase()||'?';avEl.innerHTML=d[0]?.toUpperCase()||'?';}
}

// ‚îÄ‚îÄ SORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setSort(s){
  currentSort=s;
  document.querySelectorAll('.sort-btn').forEach(b=>b.classList.toggle('active',b.dataset.sort===s));
  renderChars();
}

// ‚îÄ‚îÄ CHARACTERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const getUserChars=(u=CUK)=>DB.get(cKey(u))||[];
const saveUserChars=(arr,u=CUK)=>DB.set(cKey(u),arr);
const allPublicChars=()=>{
  const chars=[...DEFAULTS];
  getAllUsernames().forEach(u=>{
    const uc=DB.get(cKey(u))||[];
    uc.filter(c=>!c.private).forEach(c=>{if(!chars.find(x=>x.id===c.id))chars.push(c);});
  });
  return chars;
};
const allChars=()=>[...DEFAULTS,...getUserChars()];

function getMsgCount(cid){return DB.get(msgsKey(cid))||0;}
function incMsgCount(cid){DB.set(msgsKey(cid),(getMsgCount(cid)||0)+1);}
function getLikes(cid){return DB.get(likesKey(cid))||[];}
function hasLiked(cid){return getLikes(cid).includes(CUK);}
function toggleLike(e,cid){
  e.stopPropagation();
  const likes=getLikes(cid);
  const idx=likes.indexOf(CUK);
  if(idx>=0)likes.splice(idx,1);else likes.push(CUK);
  DB.set(likesKey(cid),likes);
  renderChars();
}

function getSortedChars(){
  let chars=allPublicChars().filter(c=>{
    // hide private chars (not owner)
    if(c.private&&c.createdBy!==CUK)return false;
    return true;
  });
  // also include current user's private chars
  getUserChars().filter(c=>c.private).forEach(c=>{if(!chars.find(x=>x.id===c.id))chars.push(c);});

  if(currentSort==='following'){
    const following=DB.get(followKey(CUK))||[];
    chars=chars.filter(c=>following.includes(c.createdBy)||c.id.startsWith('d'));
  }
  if(currentSort==='messages'){
    chars.sort((a,b)=>getMsgCount(b.id)-getMsgCount(a.id));
  } else if(currentSort==='popularity'){
    chars.sort((a,b)=>{
      const pa=getLikes(b.id).length+(getMsgCount(b.id)*0.1);
      const pb=getLikes(a.id).length+(getMsgCount(a.id)*0.1);
      return pa-pb;
    });
  } else if(currentSort==='recent'){
    // user chars first (newest), then defaults
    chars.sort((a,b)=>{
      if(a.id.startsWith('d')&&!b.id.startsWith('d'))return 1;
      if(!a.id.startsWith('d')&&b.id.startsWith('d'))return-1;
      return(b.createdAt||0)-(a.createdAt||0);
    });
  }
  return chars;
}

function renderChars(){
  const g=document.getElementById('charsGrid');if(!g)return;
  const chars=getSortedChars();
  g.innerHTML=chars.map(c=>{
    const imgHtml=c.image
      ?`<img class="cc-img" src="${c.image}" alt="${c.name}"/>`
      :`<div class="cc-img-placeholder">${c.avatar}</div>`;
    const isOwner=c.createdBy===CUK;
    const isDefault=c.id.startsWith('d');
    const creator=isDefault?'realm':c.createdBy||'unknown';
    const likes=getLikes(c.id).length;
    const msgs=getMsgCount(c.id);
    const liked=hasLiked(c.id);
    const priv=c.private&&isOwner;
    return`<div class="char-card ${c.private&&!isOwner?'private-hidden':''}" onclick="startChat('${c.id}')">
      ${priv?'<div class="cc-private-badge">üîí Private</div>':''}
      ${imgHtml}
      <div class="cc-name">${c.name}</div>
      <div class="cc-desc">${c.desc}</div>
      ${!isDefault?`<div class="cc-creator">by <a href="#" onclick="event.stopPropagation();openPublicProfile('${creator}')">@${creator}</a></div>`:'<div class="cc-creator" style="color:var(--text3)">by realm</div>'}
      <span class="cc-tag">${c.tag}</span>
      <div class="cc-stats">
        <span class="cc-stat"><button class="cc-like-btn ${liked?'liked':''}" onclick="toggleLike(event,'${c.id}')">‚ô•</button>${likes}</span>
        <span class="cc-stat">üí¨ ${msgs}</span>
      </div>
      <div class="cc-actions">
        ${isOwner?`<button class="cc-btn" onclick="editChar(event,'${c.id}')">‚úè</button>
        <button class="cc-btn" onclick="delChar(event,'${c.id}')">‚úï</button>`:''}
        <div style="position:relative;">
          <button class="cc-dots" onclick="toggleDotMenu(event,'dm_${c.id}')">‚ãÆ</button>
          <div class="dropdown-menu" id="dm_${c.id}">
            <button class="dd-item" onclick="openComments('${c.id}','${c.name}');closeDotMenus()">üí¨ Comments</button>
            ${CUK===ADMIN_USERNAME?`
            <div class="dd-sep"></div>
            ${!isDefault?`<button class="dd-item danger" onclick="adminForcePrivate('${c.id}','${c.createdBy}');closeDotMenus()">üîí Force Private</button>`:''}
            `:''}
          </div>
        </div>
      </div>
    </div>`;
  }).join('')+`
  <div class="char-card add-char-card" onclick="openCreateChar()">
    <div class="plus">Ôºã</div><p>Create Character</p>
  </div>`;
}

// ‚îÄ‚îÄ DOT MENUS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleDotMenu(e,id){
  e.stopPropagation();
  const menu=document.getElementById(id);
  const wasOpen=menu.classList.contains('open');
  closeDotMenus();
  if(!wasOpen)menu.classList.add('open');
}
function closeDotMenus(){document.querySelectorAll('.dropdown-menu').forEach(m=>m.classList.remove('open'));}
document.addEventListener('click',closeDotMenus);

// ‚îÄ‚îÄ MY BOTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchMyBotsTab(filter){
  myBotsTabFilter=filter;
  document.querySelectorAll('.tab-item').forEach((t,i)=>t.classList.toggle('active',(filter==='public'&&i===0)||(filter==='private'&&i===1)));
  renderMyBots();
}
function renderMyBots(){
  const el=document.getElementById('myBotsList');if(!el)return;
  const chars=getUserChars().filter(c=>myBotsTabFilter==='private'?c.private:!c.private);
  if(!chars.length){
    el.innerHTML=`<div class="empty"><div class="ei">ü§ñ</div><p>No ${myBotsTabFilter} bots yet.</p></div>`;return;
  }
  el.innerHTML=chars.map(c=>{
    const avHtml=c.image
      ?`<img class="mybot-img" src="${c.image}" alt="${c.name}"/>`
      :`<span class="mybot-av">${c.avatar}</span>`;
    const likes=getLikes(c.id).length;
    const msgs=getMsgCount(c.id);
    return`<div class="mybot-item">
      ${avHtml}
      <div class="mybot-info">
        <div class="mybot-name">${c.name}</div>
        <div class="mybot-desc">${c.desc}</div>
        <div class="mybot-meta"><span>‚ô• ${likes}</span><span>üí¨ ${msgs} msgs</span><span>${c.tag}</span></div>
      </div>
      <div class="mybot-actions">
        <button class="cc-btn vis" title="${c.private?'Make Public':'Make Private'}" onclick="toggleBotPrivacy('${c.id}')">${c.private?'üîì Make Public':'üîí Make Private'}</button>
        <button class="cc-btn" onclick="editChar(event,'${c.id}')">‚úè</button>
        <button class="cc-btn" onclick="delChar(event,'${c.id}')">‚úï</button>
      </div>
    </div>`;
  }).join('');
}
function toggleBotPrivacy(id){
  const chars=getUserChars();
  const c=chars.find(x=>x.id===id);if(!c)return;
  c.private=!c.private;
  saveUserChars(chars);
  renderMyBots();renderChars();
  toast(c.private?'Bot set to private':'Bot set to public','ok');
}

// ‚îÄ‚îÄ IMAGE UPLOAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handleImgUpload(input){
  const file=input.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{
    pendingImgData=e.target.result;
    const prev=document.getElementById('cmImgPreview');
    const ph=document.getElementById('cmImgPlaceholder');
    prev.src=pendingImgData;prev.style.display='block';ph.style.display='none';
  };
  reader.readAsDataURL(file);
}
function resetImgUpload(){
  pendingImgData=null;
  const prev=document.getElementById('cmImgPreview');
  const ph=document.getElementById('cmImgPlaceholder');
  prev.src='';prev.style.display='none';ph.style.display='block';
  document.getElementById('cmImgFile').value='';
}

// ‚îÄ‚îÄ PROFILE PICTURE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handleProfilePicUpload(input){
  const file=input.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{
    const data=e.target.result;
    CU.avatar=data;
    DB.set(uKey(CUK),CU);
    renderSbUser();
    loadProfile();
    toast('Profile picture updated','ok');
  };
  reader.readAsDataURL(file);
}

// ‚îÄ‚îÄ CHARACTER MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openCreateChar(){
  editingCharId=null;
  document.getElementById('charModalTitle').textContent='‚ú¶ Create Character';
  ['cmAv','cmName','cmDesc','cmTag','cmPersonality','cmOpening'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('cmAv').value='üßô';
  document.getElementById('cmPrivate').checked=false;
  resetImgUpload();
  document.getElementById('charModal').classList.add('open');
}
function editChar(e,id){
  e.stopPropagation();editingCharId=id;
  const c=getUserChars().find(x=>x.id===id);if(!c)return;
  document.getElementById('charModalTitle').textContent='‚ú¶ Edit Character';
  document.getElementById('cmAv').value=c.avatar||'üßô';
  document.getElementById('cmName').value=c.name||'';
  document.getElementById('cmDesc').value=c.desc||'';
  document.getElementById('cmTag').value=c.tag||'';
  document.getElementById('cmPersonality').value=c.personality||'';
  document.getElementById('cmOpening').value=c.opening||'';
  document.getElementById('cmPrivate').checked=!!c.private;
  resetImgUpload();
  if(c.image){
    pendingImgData=c.image;
    const prev=document.getElementById('cmImgPreview');
    prev.src=c.image;prev.style.display='block';
    document.getElementById('cmImgPlaceholder').style.display='none';
  }
  document.getElementById('charModal').classList.add('open');
}
function closeCharModal(){document.getElementById('charModal').classList.remove('open');}
function saveChar(){
  if(isBanned()){toast('You are banned from creating bots','err');return;}
  const name=document.getElementById('cmName').value.trim();
  const personality=document.getElementById('cmPersonality').value.trim();
  const opening=document.getElementById('cmOpening').value.trim();
  if(!name||!personality){toast('Name and personality are required','err');return;}
  if(!opening){toast('Opening message is required','err');return;}
  const isPrivate=document.getElementById('cmPrivate').checked;
  const c={id:editingCharId||'c_'+Date.now(),avatar:document.getElementById('cmAv').value||'üßô',name,personality,
    desc:document.getElementById('cmDesc').value||'A unique character',
    tag:document.getElementById('cmTag').value||'Custom',
    opening,image:pendingImgData||null,
    createdBy:CUK,
    createdAt:Date.now(),
    private:isPrivate};
  const chars=getUserChars();
  if(editingCharId){const i=chars.findIndex(x=>x.id===editingCharId);if(i>=0)chars[i]=c;else chars.push(c);}
  else chars.push(c);
  saveUserChars(chars);closeCharModal();renderChars();renderMyBots();
  toast(editingCharId?'Character updated':'Character created','ok');
}
function delChar(e,id){
  e.stopPropagation();
  if(!confirm('Delete this character?'))return;
  saveUserChars(getUserChars().filter(c=>c.id!==id));
  renderChars();renderMyBots();
}

// ‚îÄ‚îÄ PUBLIC PROFILE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openPublicProfile(username){
  if(username===CUK){showPage('profilePage');return;}
  viewingProfileUser=username;
  const u=DB.get(uKey(username));
  if(!u){toast('User not found','err');return;}
  // avatar
  const avEl=document.getElementById('pubAv');
  if(u.avatar){avEl.innerHTML=`<img src="${u.avatar}" alt=""/>`;}
  else{avEl.textContent=(u.displayName||username)[0]?.toUpperCase()||'?';avEl.innerHTML=avEl.textContent;}
  document.getElementById('pubName').textContent=u.displayName||username;
  document.getElementById('pubJoined').textContent='Joined '+new Date(u.joined).toLocaleDateString(undefined,{month:'long',year:'numeric'});
  // dev tag
  const devTag=document.getElementById('pubDevTag');
  devTag.style.display=username===ADMIN_USERNAME?'inline-block':'none';
  // bots
  const bots=(DB.get(cKey(username))||[]).filter(c=>!c.private);
  document.getElementById('pubBotCount').textContent=bots.length;
  // follow stats
  const followers=DB.get(followersKey(username))||[];
  const following=DB.get(followKey(username))||[];
  document.getElementById('pubFollowers').textContent=followers.length;
  document.getElementById('pubFollowing').textContent=following.length;
  // follow btn
  const myFollowing=DB.get(followKey(CUK))||[];
  const isFollowing=myFollowing.includes(username);
  const followBtn=document.getElementById('pubFollowBtn');
  followBtn.className='btn btn-follow btn-sm'+(isFollowing?' following':'');
  if(!isFollowing)followBtn.innerHTML='<span>Follow</span>';
  else followBtn.innerHTML='';
  // admin actions
  const adminActions=document.getElementById('pubAdminActions');
  adminActions.style.display=CUK===ADMIN_USERNAME?'flex':'none';
  document.getElementById('pubUnbanBtn').style.display=u.banned?'inline-flex':'none';
  // render bots
  const grid=document.getElementById('pubBotsGrid');
  if(!bots.length){grid.innerHTML=`<div class="empty"><div class="ei">ü§ñ</div><p>No public bots yet.</p></div>`;return;}
  grid.innerHTML=bots.map(c=>{
    const imgHtml=c.image?`<img class="cc-img" src="${c.image}" alt="${c.name}"/>`:`<div class="cc-img-placeholder">${c.avatar}</div>`;
    const likes=getLikes(c.id).length;const msgs=getMsgCount(c.id);const liked=hasLiked(c.id);
    return`<div class="char-card" onclick="startChat('${c.id}')">
      ${imgHtml}
      <div class="cc-name">${c.name}</div>
      <div class="cc-desc">${c.desc}</div>
      <span class="cc-tag">${c.tag}</span>
      <div class="cc-stats">
        <span class="cc-stat"><button class="cc-like-btn ${liked?'liked':''}" onclick="toggleLike(event,'${c.id}')">‚ô•</button>${likes}</span>
        <span class="cc-stat">üí¨ ${msgs}</span>
      </div>
      <div class="cc-actions">
        <div style="position:relative;">
          <button class="cc-dots" onclick="toggleDotMenu(event,'pdm_${c.id}')">‚ãÆ</button>
          <div class="dropdown-menu" id="pdm_${c.id}">
            <button class="dd-item" onclick="openComments('${c.id}','${c.name}');closeDotMenus()">üí¨ Comments</button>
            ${CUK===ADMIN_USERNAME?`<div class="dd-sep"></div>
            <button class="dd-item danger" onclick="adminForcePrivate('${c.id}','${username}');closeDotMenus()">üîí Force Private</button>`:''}
          </div>
        </div>
      </div>
    </div>`;
  }).join('');
  showPage('publicProfilePage');
}

function toggleFollowUser(){
  if(!viewingProfileUser)return;
  const myFollowing=DB.get(followKey(CUK))||[];
  const theirFollowers=DB.get(followersKey(viewingProfileUser))||[];
  const idx=myFollowing.indexOf(viewingProfileUser);
  if(idx>=0){
    myFollowing.splice(idx,1);
    const fi=theirFollowers.indexOf(CUK);if(fi>=0)theirFollowers.splice(fi,1);
    toast('Unfollowed');
  } else {
    myFollowing.push(viewingProfileUser);
    theirFollowers.push(CUK);
    toast('Following @'+viewingProfileUser,'ok');
  }
  DB.set(followKey(CUK),myFollowing);
  DB.set(followersKey(viewingProfileUser),theirFollowers);
  // re-open to refresh
  openPublicProfile(viewingProfileUser);
}

// ‚îÄ‚îÄ ADMIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function isAdmin(){return CUK===ADMIN_USERNAME;}
function isBanned(u=CUK){const d=DB.get(uKey(u));return d?.banned===true;}

function adminBanUser(){
  if(!isAdmin()||!viewingProfileUser)return;
  const u=DB.get(uKey(viewingProfileUser));if(!u)return;
  u.banned=true;DB.set(uKey(viewingProfileUser),u);
  toast('User banned','ok');
  openPublicProfile(viewingProfileUser);
}
function adminUnbanUser(){
  if(!isAdmin()||!viewingProfileUser)return;
  const u=DB.get(uKey(viewingProfileUser));if(!u)return;
  u.banned=false;DB.set(uKey(viewingProfileUser),u);
  toast('User unbanned','ok');
  openPublicProfile(viewingProfileUser);
}
function adminForcePrivate(charId,ownerUsername){
  if(!isAdmin())return;
  const chars=DB.get(cKey(ownerUsername))||[];
  const c=chars.find(x=>x.id===charId);if(!c)return;
  c.private=true;
  DB.set(cKey(ownerUsername),chars);
  renderChars();
  if(viewingProfileUser)openPublicProfile(viewingProfileUser);
  toast('Bot forced private','ok');
}
function adminDeleteComment(charId,commentId){
  if(!isAdmin())return;
  const comments=DB.get(commentsKey(charId))||[];
  DB.set(commentsKey(charId),comments.filter(c=>c.id!==commentId));
  renderComments(charId);
  toast('Comment deleted','ok');
}

// ‚îÄ‚îÄ COMMENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openComments(charId,charName){
  currentCommentCharId=charId;
  clearCommentImg();
  document.getElementById('commentText').value='';
  document.getElementById('commentsModalTitle').textContent=`üí¨ ${charName}`;
  // hide input if banned
  document.getElementById('commentInputArea').style.display=isBanned()?'none':'flex';
  renderComments(charId);
  document.getElementById('commentsModal').classList.add('open');
}
function closeCommentsModal(){
  document.getElementById('commentsModal').classList.remove('open');
  currentCommentCharId=null;
}
function renderComments(charId){
  const list=document.getElementById('commentsList');
  const comments=DB.get(commentsKey(charId))||[];
  if(!comments.length){list.innerHTML=`<div style="color:var(--text3);font-style:italic;font-size:0.82rem;text-align:center;padding:1rem;">No comments yet. Be the first!</div>`;return;}
  list.innerHTML=comments.map(c=>{
    const u=DB.get(uKey(c.author))||{};
    const avHtml=u.avatar?`<img src="${u.avatar}" alt=""/>`:(c.author[0]?.toUpperCase()||'?');
    const isAdminOrOwner=isAdmin()||c.author===CUK;
    return`<div class="comment-item">
      <div class="comment-header">
        <div class="comment-av">${avHtml}</div>
        <span class="comment-author" onclick="openPublicProfile('${c.author}')">@${c.author}</span>
        <span class="comment-time">${new Date(c.time).toLocaleDateString(undefined,{month:'short',day:'numeric'})}</span>
        ${isAdminOrOwner?`<button class="comment-del" onclick="${isAdmin()&&c.author!==CUK?`adminDeleteComment('${charId}','${c.id}')`:`deleteMyComment('${charId}','${c.id}')`}">‚úï</button>`:''}
      </div>
      <div class="comment-text">${escHtml(c.text)}</div>
      ${c.image?`<img class="comment-img" src="${c.image}" alt="comment image"/>`:''}
    </div>`;
  }).join('');
}
function deleteMyComment(charId,commentId){
  const comments=DB.get(commentsKey(charId))||[];
  DB.set(commentsKey(charId),comments.filter(c=>!(c.id===commentId&&c.author===CUK)));
  renderComments(charId);
}
function handleCommentImg(input){
  const file=input.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{
    commentPendingImg=e.target.result;
    const prev=document.getElementById('commentImgPreview');
    prev.src=commentPendingImg;prev.style.display='block';
    document.getElementById('commentImgClear').classList.add('vis');
  };
  reader.readAsDataURL(file);
}
function clearCommentImg(){
  commentPendingImg=null;
  document.getElementById('commentImgPreview').style.display='none';
  document.getElementById('commentImgPreview').src='';
  document.getElementById('commentImgClear').classList.remove('vis');
  document.getElementById('commentImgFile').value='';
}
function submitComment(){
  if(isBanned()){toast('You are banned from posting comments','err');return;}
  const text=document.getElementById('commentText').value.trim();
  if(!text&&!commentPendingImg){toast('Write something first','err');return;}
  if(!currentCommentCharId)return;
  const comments=DB.get(commentsKey(currentCommentCharId))||[];
  comments.push({id:'cmt_'+Date.now(),author:CUK,text,image:commentPendingImg||null,time:new Date().toISOString()});
  DB.set(commentsKey(currentCommentCharId),comments);
  document.getElementById('commentText').value='';
  clearCommentImg();
  renderComments(currentCommentCharId);
  toast('Comment posted','ok');
}
function escHtml(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML;}

// ‚îÄ‚îÄ CHAT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startChat(charId,savedData=null){
  if(!apiKey){toast('Set your API key first ‚Üí API Key tab','err');showPage('apiPage');return;}
  const c=allChars().find(x=>x.id===charId)||allPublicChars().find(x=>x.id===charId);if(!c)return;
  // check if private & not owner
  if(c.private&&c.createdBy!==CUK){toast('This bot is private','err');return;}
  activeChar=c;activeChatId=savedData?.id||null;chatHistory=savedData?.history||[];
  const chatAvEl=document.getElementById('chatAv');
  if(c.image){
    chatAvEl.innerHTML=`<img src="${c.image}" style="width:36px;height:36px;border-radius:50%;object-fit:cover;border:1px solid var(--border2);" alt="${c.name}"/>`;
  } else {
    chatAvEl.textContent=c.avatar;
  }
  document.getElementById('chatName').textContent=c.name;
  document.getElementById('chatSub').textContent='In character‚Ä¶';
  const area=document.getElementById('messages');area.innerHTML='';
  if(chatHistory.length>0){
    chatHistory.forEach((m,i)=>appendMsg(m.role==='assistant'?'ai':'user',m.content,m.role==='assistant'?c.avatar:'üßë',i));
  } else {
    if(c.opening){chatHistory.push({role:'assistant',content:c.opening});appendMsg('ai',c.opening,c.avatar,0);}
    else area.innerHTML='<div class="narr">‚Äî The scene begins ‚Äî</div>';
  }
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('chatView').classList.add('active');
  document.getElementById('msgInput').focus();closeSidebar();
}
function exitChat(){
  document.getElementById('chatView').classList.remove('active');
  activeChar=null;chatHistory=[];activeChatId=null;
  if(!document.querySelector('.page.active'))document.getElementById('charsPage').classList.add('active');
}
function clearMessages(){
  if(!activeChar)return;chatHistory=[];activeChatId=null;
  const area=document.getElementById('messages');area.innerHTML='<div class="narr">‚Äî Scene reset ‚Äî</div>';
  if(activeChar.opening){chatHistory.push({role:'assistant',content:activeChar.opening});appendMsg('ai',activeChar.opening,activeChar.avatar,0);}
}
function buildSysPrompt(){
  const persona=DB.get(pKey(CUK))||{};
  let pb='';
  if(persona.name||persona.role||persona.about||persona.extra){
    pb='\n\nUSER PERSONA:\n';
    if(persona.name)pb+=`- Call them: ${persona.name}\n`;
    if(persona.role)pb+=`- Their role: ${persona.role}\n`;
    if(persona.about)pb+=`- About them: ${persona.about}\n`;
    if(persona.extra)pb+=`- Extra: ${persona.extra}\n`;
  }
  return `${activeChar.personality}${pb}

ROLEPLAY RULES:
- You ARE ${activeChar.name}. Never break character or mention being an AI.
- This is a creative fiction space. Violence, dark themes, moral complexity, and intense conflict are all permitted as storytelling.
- Use *asterisks for actions and stage directions*.
- Be immersive, reactive, move the story forward.
- Keep responses 2-5 paragraphs unless the scene needs more.`;
}
async function sendMsg(){
  const inp=document.getElementById('msgInput');
  const text=inp.value.trim();if(!text||!activeChar)return;
  inp.value='';inp.style.height='auto';
  document.getElementById('sendBtn').disabled=true;
  chatHistory.push({role:'user',content:text});
  appendMsg('user',text,'üßë',chatHistory.length-1);
  const typing=appendTyping(activeChar.avatar);
  try{
    const sys=buildSysPrompt();
    const res=await fetch('https://openrouter.ai/api/v1/chat/completions',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+apiKey,'HTTP-Referer':location.href,'X-Title':'Realm Chat'},
      body:JSON.stringify({model:selModel,messages:[{role:'system',content:sys},...chatHistory.slice(-30)],max_tokens:1024})
    });
    if(!res.ok){const err=await res.json().catch(()=>({}));throw new Error(err.error?.message||`HTTP ${res.status}`);}
    const data=await res.json();
    const reply=data.choices?.[0]?.message?.content||'...';
    typing.remove();
    chatHistory.push({role:'assistant',content:reply});
    appendMsg('ai',reply,activeChar.avatar,chatHistory.length-1);
    incMsgCount(activeChar.id);
    autoSave();
  }catch(err){typing.remove();toast('Error: '+err.message,'err');chatHistory.pop();}
  document.getElementById('sendBtn').disabled=false;
  document.getElementById('msgInput').focus();
}
function fmtText(text){
  return text.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\*(.*?)\*/g,'<em>$1</em>').replace(/\n/g,'<br>');
}
function appendMsg(type,text,avatar,histIdx){
  const area=document.getElementById('messages');
  const div=document.createElement('div');
  div.className='msg '+type;
  div.dataset.idx=histIdx!==undefined?histIdx:chatHistory.length-1;
  const isAi=type==='ai';
  const actionsHtml=isAi
    ?`<div class="msg-actions">
        <button class="ma-btn" onclick="continueMsg(this)">‚ñ∂ Continue</button>
        <button class="ma-btn" onclick="regenMsg(this)">‚Ü∫ Regenerate</button>
        <button class="ma-btn" onclick="editMsg(this)">‚úè Edit</button>
        <button class="ma-btn danger" onclick="deleteFromMsg(this)">üóë Delete</button>
      </div>`
    :`<div class="msg-actions">
        <button class="ma-btn" onclick="editMsg(this)">‚úè Edit</button>
        <button class="ma-btn danger" onclick="deleteFromMsg(this)">üóë Delete &amp; rewind</button>
      </div>`;
  div.innerHTML=`<div class="msg-av">${avatar}</div>
    <div class="msg-wrap">
      <div class="bubble">${fmtText(text)}</div>
      ${actionsHtml}
    </div>`;
  area.appendChild(div);area.scrollTop=area.scrollHeight;return div;
}
function appendTyping(av){
  const area=document.getElementById('messages');
  const div=document.createElement('div');div.className='msg ai';
  div.innerHTML=`<div class="msg-av">${av}</div><div class="bubble"><div class="typing-bub"><span></span><span></span><span></span></div></div>`;
  area.appendChild(div);area.scrollTop=area.scrollHeight;return div;
}
function getMsgEl(btn){return btn.closest('.msg');}
function getMsgIdx(btn){return parseInt(getMsgEl(btn).dataset.idx);}

async function continueMsg(btn){
  const idx=getMsgIdx(btn);
  if(idx<0||idx>=chatHistory.length)return;
  const lastContent=chatHistory[idx].content;
  const continueHistory=[...chatHistory.slice(0,idx+1),{role:'user',content:'[Continue your previous message exactly from where you left off. Do not repeat what you already said, just continue seamlessly.]'}];
  document.getElementById('sendBtn').disabled=true;
  const typing=appendTyping(activeChar.avatar);
  try{
    const sys=buildSysPrompt();
    const res=await fetch('https://openrouter.ai/api/v1/chat/completions',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+apiKey,'HTTP-Referer':location.href,'X-Title':'Realm Chat'},
      body:JSON.stringify({model:selModel,messages:[{role:'system',content:sys},...continueHistory.slice(-30)],max_tokens:1024})
    });
    if(!res.ok){const err=await res.json().catch(()=>({}));throw new Error(err.error?.message||`HTTP ${res.status}`);}
    const data=await res.json();
    const continuation=data.choices?.[0]?.message?.content||'...';
    typing.remove();
    chatHistory[idx].content=lastContent+'\n'+continuation;
    const msgEl=document.querySelector(`.msg[data-idx="${idx}"]`);
    if(msgEl){msgEl.querySelector('.bubble').innerHTML=fmtText(chatHistory[idx].content);}
    autoSave();
  }catch(err){typing.remove();toast('Error: '+err.message,'err');}
  document.getElementById('sendBtn').disabled=false;
}
async function regenMsg(btn){
  const idx=getMsgIdx(btn);
  if(idx<0||idx>=chatHistory.length||chatHistory[idx].role!=='assistant')return;
  chatHistory=chatHistory.slice(0,idx);
  const area=document.getElementById('messages');
  area.querySelectorAll('.msg').forEach(el=>{if(parseInt(el.dataset.idx)>=idx)el.remove();});
  document.getElementById('sendBtn').disabled=true;
  const typing=appendTyping(activeChar.avatar);
  try{
    const sys=buildSysPrompt();
    const res=await fetch('https://openrouter.ai/api/v1/chat/completions',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+apiKey,'HTTP-Referer':location.href,'X-Title':'Realm Chat'},
      body:JSON.stringify({model:selModel,messages:[{role:'system',content:sys},...chatHistory.slice(-30)],max_tokens:1024})
    });
    if(!res.ok){const err=await res.json().catch(()=>({}));throw new Error(err.error?.message||`HTTP ${res.status}`);}
    const data=await res.json();
    const reply=data.choices?.[0]?.message?.content||'...';
    typing.remove();
    chatHistory.push({role:'assistant',content:reply});
    appendMsg('ai',reply,activeChar.avatar,chatHistory.length-1);
    autoSave();
  }catch(err){typing.remove();toast('Error: '+err.message,'err');}
  document.getElementById('sendBtn').disabled=false;
}
function editMsg(btn){
  const msgEl=getMsgEl(btn);
  const idx=getMsgIdx(btn);
  const bubble=msgEl.querySelector('.bubble');
  const actions=msgEl.querySelector('.msg-actions');
  const originalText=chatHistory[idx]?.content||'';
  bubble.style.display='none';
  actions.style.display='none';
  const wrap=msgEl.querySelector('.msg-wrap');
  const ta=document.createElement('textarea');
  ta.className='bubble-edit';ta.value=originalText;
  const editActs=document.createElement('div');
  editActs.className='edit-actions';
  editActs.innerHTML=`<button class="ma-btn confirm" onclick="confirmEdit(this,${idx})">‚úì Save</button><button class="ma-btn" onclick="cancelEdit(this)">‚úï Cancel</button>`;
  wrap.appendChild(ta);wrap.appendChild(editActs);
  ta.focus();ta.style.height='auto';ta.style.height=ta.scrollHeight+'px';
}
function confirmEdit(btn,idx){
  const wrap=btn.closest('.msg-wrap');
  const ta=wrap.querySelector('.bubble-edit');
  const newText=ta.value.trim();
  if(!newText){toast('Message cannot be empty','err');return;}
  chatHistory[idx].content=newText;
  if(chatHistory[idx].role==='user'){
    chatHistory=chatHistory.slice(0,idx+1);
    const area=document.getElementById('messages');
    area.querySelectorAll('.msg').forEach(el=>{if(parseInt(el.dataset.idx)>idx)el.remove();});
  }
  cancelEdit(btn);
  const msgEl=btn.closest('.msg');
  const bubble=msgEl.querySelector('.bubble');
  bubble.innerHTML=fmtText(newText);
  autoSave();
  toast('Edited','ok');
}
function cancelEdit(btn){
  const wrap=btn.closest('.msg-wrap');
  wrap.querySelector('.bubble-edit')?.remove();
  wrap.querySelector('.edit-actions')?.remove();
  wrap.querySelector('.bubble').style.display='';
  wrap.querySelector('.msg-actions').style.display='';
}
function deleteFromMsg(btn){
  const idx=getMsgIdx(btn);
  if(idx<0)return;
  if(!confirm('Delete this message and everything after it?'))return;
  chatHistory=chatHistory.slice(0,idx);
  const area=document.getElementById('messages');
  area.querySelectorAll('.msg').forEach(el=>{if(parseInt(el.dataset.idx)>=idx)el.remove();});
  autoSave();
  toast('Rewound','ok');
}
document.getElementById('msgInput')?.addEventListener('input',function(){this.style.height='auto';this.style.height=Math.min(this.scrollHeight,115)+'px';});
document.getElementById('msgInput')?.addEventListener('keydown',function(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMsg();}});

// ‚îÄ‚îÄ SAVED CHATS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const getSaved=()=>DB.get(chatKey(CUK))||[];
const setSaved=arr=>DB.set(chatKey(CUK),arr);
function autoSave(){
  if(!activeChar||chatHistory.length<2)return;
  const chats=getSaved();
  const last=chatHistory[chatHistory.length-1]?.content||'';
  const prev=last.replace(/<[^>]+>/g,'').slice(0,65);
  const now=new Date().toISOString();
  if(activeChatId){
    const i=chats.findIndex(c=>c.id===activeChatId);
    if(i>=0){chats[i]={...chats[i],history:chatHistory,preview:prev,updatedAt:now};setSaved(chats);renderSbChats();return;}
  }
  const id='ch_'+Date.now();activeChatId=id;
  chats.unshift({id,charId:activeChar.id,charName:activeChar.name,charAvatar:activeChar.avatar,charImage:activeChar.image||null,history:chatHistory,preview:prev,createdAt:now,updatedAt:now});
  setSaved(chats);renderSbChats();
}
function renderSbChats(){
  const el=document.getElementById('sbChats');if(!el)return;
  const chats=getSaved().slice(0,10);
  if(!chats.length){el.innerHTML='<div style="padding:.5rem 1rem;font-size:.72rem;color:var(--text3);font-style:italic;">No chats yet</div>';return;}
  el.innerHTML=chats.map(c=>{
    const avHtml=c.charImage
      ?`<img src="${c.charImage}" style="width:22px;height:22px;border-radius:50%;object-fit:cover;" alt=""/>`
      :`<span class="sci-av">${c.charAvatar}</span>`;
    return`<button class="sb-chat-item ${activeChatId===c.id?'active':''}" onclick="resumeChat('${c.id}')">
      ${avHtml}
      <div class="sci-info"><div class="sci-name">${c.charName}</div><div class="sci-prev">${c.preview||'‚Ä¶'}</div></div>
      <span class="sci-del" onclick="delSaved(event,'${c.id}')">‚úï</span>
    </button>`;}).join('');
}
function renderSavedPage(){
  const el=document.getElementById('savedList');if(!el)return;
  const chats=getSaved();
  if(!chats.length){el.innerHTML=`<div class="empty"><div class="ei">üìú</div><p>No saved chats yet.<br>Start chatting ‚Äî it auto-saves!</p></div>`;return;}
  el.innerHTML=chats.map(c=>{
    const d=new Date(c.updatedAt);
    const t=d.toLocaleDateString(undefined,{month:'short',day:'numeric'});
    const avHtml=c.charImage
      ?`<img src="${c.charImage}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;flex-shrink:0;" alt=""/>`
      :`<span class="si-av">${c.charAvatar}</span>`;
    return`<div class="saved-item" onclick="resumeChat('${c.id}')">
      ${avHtml}
      <div class="si-info"><div class="si-name">${c.charName}</div><div class="si-prev">${c.preview||'‚Ä¶'}</div></div>
      <span class="si-time">${t}</span>
      <button class="si-del" onclick="delSaved(event,'${c.id}')">‚úï</button>
    </div>`;}).join('');
}
function resumeChat(id){
  const chat=getSaved().find(c=>c.id===id);if(!chat)return;
  const char=allChars().find(c=>c.id===chat.charId)||allPublicChars().find(c=>c.id===chat.charId);
  if(!char){toast('Character no longer exists','err');return;}
  startChat(chat.charId,{id:chat.id,history:chat.history});
}
function delSaved(e,id){
  e.stopPropagation();if(!confirm('Delete this saved chat?'))return;
  setSaved(getSaved().filter(c=>c.id!==id));
  if(activeChatId===id)exitChat();
  renderSbChats();renderSavedPage();
}

// ‚îÄ‚îÄ PERSONA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadPersona(){const p=DB.get(pKey(CUK))||{};document.getElementById('pName').value=p.name||'';document.getElementById('pRole').value=p.role||'';document.getElementById('pAbout').value=p.about||'';document.getElementById('pExtra').value=p.extra||'';}
function savePersona(){DB.set(pKey(CUK),{name:document.getElementById('pName').value.trim(),role:document.getElementById('pRole').value.trim(),about:document.getElementById('pAbout').value.trim(),extra:document.getElementById('pExtra').value.trim()});toast('Persona saved','ok');}

// ‚îÄ‚îÄ PROFILE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadProfile(){
  const u=CU;
  document.getElementById('pfUser').value=u?.username||CUK;
  document.getElementById('pfDisplay').value=u?.displayName||'';
  document.getElementById('pfEmail').value=u?.email||'';
  const d=u?.joined?new Date(u.joined).toLocaleDateString(undefined,{month:'long',year:'numeric'}):'Unknown';
  document.getElementById('pfJoined').textContent=d;
  const disp=u?.displayName||CUK||'?';
  document.getElementById('pfDispName').textContent=disp;
  // dev tag
  document.getElementById('pfDevTag').style.display=CUK===ADMIN_USERNAME?'inline-block':'none';
  // avatar
  const avBig=document.getElementById('pfAvBig');
  // preserve the overlay and input
  const overlay=avBig.querySelector('.av-overlay');
  const fileInput=avBig.querySelector('input[type=file]');
  if(u?.avatar){
    // remove old text nodes / img
    Array.from(avBig.childNodes).forEach(n=>{if(n!==overlay&&n!==fileInput)n.remove();});
    const img=document.createElement('img');img.src=u.avatar;
    avBig.insertBefore(img,overlay);
  } else {
    Array.from(avBig.childNodes).forEach(n=>{if(n!==overlay&&n!==fileInput)n.remove();});
    avBig.insertBefore(document.createTextNode(disp[0]?.toUpperCase()||'?'),overlay);
  }
  // stats
  const myBots=getUserChars().filter(c=>!c.private).length;
  const followers=(DB.get(followersKey(CUK))||[]).length;
  const following=(DB.get(followKey(CUK))||[]).length;
  document.getElementById('pfBotCount').textContent=myBots;
  document.getElementById('pfFollowerCount').textContent=followers;
  document.getElementById('pfFollowingCount').textContent=following;
  // banned notice
  document.getElementById('pfBannedNotice').style.display=isBanned()?'block':'none';
}
function saveProfile(){
  const disp=document.getElementById('pfDisplay').value.trim();
  const email=document.getElementById('pfEmail').value.trim();
  const s=DB.get(uKey(CUK));if(!s)return;
  s.displayName=disp||s.displayName;s.email=email;
  DB.set(uKey(CUK),s);CU=s;loadProfile();renderSbUser();toast('Profile saved','ok');
}

// ‚îÄ‚îÄ API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadApiFields(){const s=DB.get(sKey(CUK))||{};document.getElementById('apiKeyInput').value=s.apiKey||'';document.getElementById('modelSelect').value=s.model||'openrouter/free';}
function saveApiSettings(){
  const k=document.getElementById('apiKeyInput').value.trim();
  const m=document.getElementById('modelSelect').value;
  if(!k){toast('Enter an API key','err');return;}
  apiKey=k;selModel=m;DB.set(sKey(CUK),{apiKey:k,model:m});toast('Settings saved','ok');
}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toast(msg,type=''){const t=document.getElementById('toast');t.textContent=msg;t.className='toast show'+(type?' '+type:'');clearTimeout(t._t);t._t=setTimeout(()=>t.className='toast',3000);}
</script>
</body>
</html>
